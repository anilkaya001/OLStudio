<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <meta name="description" content="Econometric research and independent analysis by Anƒ±l Kaya, specializing in Bayesian Vector Autoregression, time series, and macroeconomic modeling." />
  <meta name="theme-color" content="#050505" />
  <title>Anƒ±l Kaya | Econometric Insights</title>

  <link rel="preconnect" href="https://polyfill.io" crossorigin />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />

  <!-- Latin Modern (webfonts) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sugina-dev/latin-modern-web@1.0.1/style/latinmodern-roman.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sugina-dev/latin-modern-web@1.0.1/style/latinmodern-sans.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sugina-dev/latin-modern-web@1.0.1/style/latinmodern-mono.css" />

  <style>
    :root{
      color-scheme: light dark;

      --font-main: "Latin Modern Roman", "Times New Roman", Times, serif;
      --font-ui: "Latin Modern Sans", "Latin Modern Roman", serif;
      --font-mono: "Latin Modern Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;

      --nav-h: 64px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);

      /* Dark (default) */
      --bg: #050505;
      --panel: rgba(18,18,18,0.72);
      --panel-strong: rgba(10,10,10,0.92);
      --border: rgba(255,255,255,0.10);

      --silver: #e2e2e2;
      --silver-dim: rgba(226,226,226,0.70);

      --gold: #D4AF37;
      --gold-soft: #F7E7CE;

      --link: var(--gold-soft);
      --shadow: 0 18px 50px -18px rgba(0,0,0,0.75);

      /* Canvas */
      --canvas-bg: #050505;
      --canvas-ink: rgba(212,175,55,0.46);
      --canvas-ink-soft: rgba(212,175,55,0.18);
      --canvas-stroke: rgba(0,0,0,0.55);
      --canvas-glow: rgba(212,175,55,0.34);
    }

    html[data-theme="light"]{
      color-scheme: light;

      --bg: #fbfbfc;
      --panel: rgba(255,255,255,0.82);
      --panel-strong: rgba(255,255,255,0.94);
      --border: rgba(0,0,0,0.10);

      --silver: #1b1b1c;
      --silver-dim: rgba(27,27,28,0.72);

      --gold: #B88A00;
      --gold-soft: #7A5A00;

      --link: #7A5A00;
      --shadow: 0 18px 55px -25px rgba(0,0,0,0.22);

      --canvas-bg: #fbfbfc;
      --canvas-ink: rgba(184,138,0,0.26);
      --canvas-ink-soft: rgba(184,138,0,0.10);
      --canvas-stroke: rgba(255,255,255,0.70);
      --canvas-glow: rgba(184,138,0,0.12);
    }

    *{ margin:0; padding:0; box-sizing:border-box; -webkit-font-smoothing: antialiased; }
    html, body{ height:100%; }
    body{
      background: var(--bg);
      color: var(--silver);
      font-family: var(--font-main);
      overflow: hidden;         /* prevent body scroll */
      overflow-x: hidden;       /* never allow horizontal scrolling */
      overscroll-behavior: none;
    }

    a{ color: var(--link); text-decoration: none; }
    a:hover{ opacity: 0.88; }

    :focus-visible{
      outline: 2px solid color-mix(in oklab, var(--gold) 65%, #fff);
      outline-offset: 3px;
      border-radius: 12px;
    }

    .hidden{ display:none !important; pointer-events:none; opacity:0; }

    /* Background canvas */
    #econometric-canvas{
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      pointer-events: none;
    }

    /* Nav */
    #global-nav{
      position: fixed;
      top: 0; left: 0; right: 0;
      height: calc(var(--nav-h) + var(--safe-top));
      padding-top: var(--safe-top);
      padding-left: clamp(14px, 4vw, 40px);
      padding-right: clamp(14px, 4vw, 40px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      z-index: 1000;
      background: rgba(0,0,0,0.01);
      transition: background 240ms ease, backdrop-filter 240ms ease, border-color 240ms ease;
    }
    #global-nav.scrolled{
      background: var(--panel-strong);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border);
    }

    .brand{
      font-family: var(--font-ui);
      font-size: 0.92rem;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--gold);
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    .nav-actions{
      display:flex;
      align-items:center;
      gap: 10px;
    }

    .nav-btn{
      font-family: var(--font-ui);
      font-size: 0.82rem;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--silver);
      cursor: pointer;
      backdrop-filter: blur(12px);
      transition: transform 160ms ease, border-color 200ms ease, background 200ms ease;
      white-space: nowrap;
    }
    .nav-btn:hover{
      transform: translateY(-1px);
      border-color: color-mix(in oklab, var(--gold) 45%, var(--border));
    }
    .nav-link-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      text-decoration: none;
    }

    /* Reading progress */
    #reading-progress{
      position: fixed;
      top: calc(var(--nav-h) + var(--safe-top));
      left: 0;
      height: 2px;
      width: 0%;
      z-index: 1001;
      opacity: 0;
      background: linear-gradient(90deg, var(--gold), color-mix(in oklab, var(--gold) 35%, #fff));
      box-shadow: 0 0 12px color-mix(in oklab, var(--gold) 55%, transparent);
      transition: opacity 220ms ease, width 80ms linear;
    }

    /* Views: fixed, scrollable, constrained to viewport */
    .view{
      position: fixed;
      inset: 0;
      height: 100dvh;                 /* mobile dynamic viewport height */
      width: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      touch-action: pan-y;            /* allow vertical scrolling on mobile */
      z-index: 2;
      opacity: 0;
      transform: translateY(14px);
      transition: opacity 320ms ease, transform 320ms ease;
      padding-bottom: calc(var(--safe-bottom) + 24px);
    }
    .view.active{
      opacity: 1;
      transform: translateY(0);
    }

    /* Landing */
    #view-landing{
      z-index: 10;
      display: grid;
      place-items: center;
      padding-top: calc(var(--nav-h) + var(--safe-top) + 24px);
      background: radial-gradient(circle at 50% 40%, rgba(150,120,20,0.10), rgba(0,0,0,0.0) 55%);
    }
    .landing{ width: min(980px, 100%); text-align: center; padding: 0 16px; }
    .landing h1{
      font-family: var(--font-main);
      color: color-mix(in oklab, var(--silver) 20%, #fff);
      font-weight: 300;
      letter-spacing: 0.08em;
      line-height: 1.05;
      font-size: clamp(2.6rem, 10vw, 6rem);
      text-shadow: 0 0 30px color-mix(in oklab, var(--gold) 25%, transparent);
      margin-bottom: 14px;
    }
    .landing .divider{
      width: 88px; height: 1px;
      background: color-mix(in oklab, var(--gold) 70%, transparent);
      opacity: 0.75;
      margin: 0 auto 22px;
    }
    .landing-actions{
      display:flex;
      justify-content:center;
      align-items:center;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
    }
    .cta{
      font-family: var(--font-ui);
      font-size: 0.86rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      padding: 14px 18px;
      border-radius: 14px;
      border: 1px solid color-mix(in oklab, var(--gold) 55%, var(--border));
      background: color-mix(in oklab, var(--panel) 78%, transparent);
      color: var(--silver);
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: transform 160ms ease, background 200ms ease, border-color 200ms ease;
      white-space: nowrap;
    }
    .cta:hover{ transform: translateY(-2px); }
    .cta.gold{ color: var(--gold); }

    /* Deck */
    #view-deck{
      padding-top: calc(var(--nav-h) + var(--safe-top) + 28px);
      background: color-mix(in oklab, var(--bg) 70%, transparent);
    }
    .deck-header{
      text-align:center;
      margin: 8px auto 26px;
      padding: 0 16px;
      max-width: 1200px;
    }
    .deck-header h2{
      font-family: var(--font-main);
      color: var(--gold-soft);
      font-size: clamp(2.1rem, 5.5vw, 3.3rem);
      font-weight: 300;
      letter-spacing: 0.02em;
      margin-bottom: 10px;
    }
    .deck-header .line{
      width: 68px; height: 1px;
      margin: 0 auto;
      background: var(--gold);
      opacity: 0.7;
    }
    .card-grid{
      max-width: 1300px;
      margin: 0 auto;
      padding: 18px clamp(16px, 4vw, 44px);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(min(360px, 100%), 1fr));
      gap: 18px;
    }
    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      backdrop-filter: blur(14px);
      padding: 22px;
      min-height: 320px;
      display:flex;
      flex-direction: column;
      gap: 12px;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: transform 220ms ease, border-color 240ms ease, background 240ms ease;
      max-width: 100%;
    }
    .card:hover{
      transform: translateY(-6px);
      border-color: color-mix(in oklab, var(--gold) 55%, var(--border));
      background: color-mix(in oklab, var(--panel) 88%, rgba(255,255,255,0.02));
    }
    .card-top{
      display:flex;
      justify-content: space-between;
      align-items: baseline;
      font-family: var(--font-ui);
      font-size: 0.72rem;
      letter-spacing: 1.6px;
      text-transform: uppercase;
      color: var(--gold);
      border-bottom: 1px solid color-mix(in oklab, var(--border) 55%, transparent);
      padding-bottom: 10px;
      gap: 10px;
    }
    .card h3{
      font-family: var(--font-main);
      font-size: 1.9rem;
      line-height: 1.15;
      font-weight: 400;
      color: var(--gold-soft);
      margin-top: 4px;
      overflow-wrap: anywhere;
    }
    .card p{
      font-family: var(--font-main);
      color: var(--silver-dim);
      font-size: 1.05rem;
      line-height: 1.6;
      overflow-wrap: anywhere;
    }
    .card .read{
      margin-top:auto;
      font-family: var(--font-ui);
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1.4px;
      color: var(--gold);
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }
    .card[aria-disabled="true"]{
      opacity: 0.45;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Reader */
    #view-reader{
      padding-top: calc(var(--nav-h) + var(--safe-top) + 18px);
      background: var(--bg);
    }
    .reader-shell{
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px clamp(16px, 4vw, 44px) 60px;
    }
    .reader-layout{
      display:grid;
      grid-template-columns: 260px 1fr;
      gap: clamp(22px, 5vw, 54px);
      align-items: start;
      margin-top: 14px;
      max-width: 100%;
    }
    @media (max-width: 980px){
      .reader-layout{ grid-template-columns: 1fr; }
    }

    /* Desktop TOC */
    .toc{
      position: sticky;
      top: calc(var(--nav-h) + var(--safe-top) + 18px);
      align-self: start;
      padding-left: 16px;
      border-left: 1px solid var(--border);
      max-height: calc(100dvh - (var(--nav-h) + var(--safe-top) + 44px));
      overflow: auto;
      overflow-x: hidden;
    }
    @media (max-width: 980px){
      .toc{ display:none; }
    }
    .toc h4{
      font-family: var(--font-ui);
      font-size: 0.74rem;
      letter-spacing: 1.6px;
      text-transform: uppercase;
      color: var(--silver-dim);
      margin-bottom: 12px;
    }
    .toc ul{ list-style:none; }
    .toc li{ margin: 0 0 10px; }
    .toc a{
      font-family: var(--font-ui);
      font-size: 0.88rem;
      line-height: 1.35;
      color: color-mix(in oklab, var(--silver) 55%, var(--silver-dim));
      display:block;
      transition: color 160ms ease, transform 160ms ease;
      overflow-wrap: anywhere;
    }
    .toc a:hover{ color: var(--gold); transform: translateX(4px); }
    .toc a.active{
      color: var(--gold);
      border-left: 2px solid var(--gold);
      padding-left: 10px;
      margin-left: -12px;
    }

    /* Mobile TOC */
    .mobile-toc{
      display:none;
      margin: 8px 0 18px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 14px;
      backdrop-filter: blur(14px);
      max-width: 100%;
    }
    @media (max-width: 980px){
      .mobile-toc{ display:block; }
    }
    .mobile-toc summary{
      font-family: var(--font-ui);
      color: var(--gold);
      letter-spacing: 1.2px;
      text-transform: uppercase;
      font-weight: 700;
      font-size: 0.82rem;
      cursor: pointer;
      list-style:none;
      user-select:none;
    }
    .mobile-toc summary::-webkit-details-marker{ display:none; }
    .mobile-toc .toc-links{
      margin-top: 12px;
      display:grid;
      gap: 10px;
    }
    .mobile-toc .toc-links a{
      font-family: var(--font-ui);
      font-size: 0.92rem;
      line-height: 1.35;
      color: color-mix(in oklab, var(--silver) 60%, var(--silver-dim));
      overflow-wrap: anywhere;
    }

    .article{ max-width: 760px; min-width: 0; }
    .article-header{
      padding: 14px 0 22px;
      margin-bottom: 22px;
      border-bottom: 1px solid var(--border);
    }
    .meta{
      font-family: var(--font-ui);
      font-size: 0.78rem;
      letter-spacing: 1.6px;
      text-transform: uppercase;
      color: var(--silver-dim);
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
    }
    .meta .pill{
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--panel) 70%, transparent);
      padding: 6px 10px;
      border-radius: 999px;
      color: var(--gold);
    }
    .article h1{
      margin-top: 12px;
      font-family: var(--font-main);
      font-weight: 400;
      line-height: 1.06;
      font-size: clamp(2.2rem, 5.4vw, 4rem);
      color: var(--gold-soft);
      letter-spacing: 0.01em;
      overflow-wrap: anywhere;
    }

    /* Content: justified + constrained (never beyond screen) */
    .article .content{
      font-family: var(--font-main);
      font-size: clamp(1.08rem, 2.2vw, 1.30rem);
      line-height: 1.75;
      color: var(--silver);
      max-width: 100%;
      overflow-wrap: anywhere;
      word-break: normal;
      hyphens: auto;

      /* ‚Äújustified vertical alignment‚Äù interpreted as strong justified typesetting */
      text-align: justify;
      text-justify: inter-word;
    }
    @media (max-width: 980px){
      .article .content{
        font-size: 1.12rem;
        line-height: 1.70;
        text-align: justify;
      }
    }

    .article .content p{
      margin: 0 0 1.6rem;
      color: color-mix(in oklab, var(--silver) 88%, var(--silver-dim));
    }

    .article .content strong,
    .article .content b{
      color: var(--gold);
      font-weight: 700;
    }

    .article .content h2{
      margin: 2.6rem 0 1rem;
      font-size: clamp(1.55rem, 3.5vw, 2.2rem);
      font-weight: 500;
      color: var(--gold-soft);
      padding-bottom: 0.45rem;
      border-bottom: 1px solid color-mix(in oklab, var(--gold) 22%, var(--border));
      overflow-wrap: anywhere;
    }

    .article .content h3{
      margin: 2.0rem 0 0.8rem;
      font-size: clamp(1.25rem, 2.8vw, 1.55rem);
      font-weight: 500;
      font-style: italic;
      color: color-mix(in oklab, var(--silver) 25%, #fff);
      overflow-wrap: anywhere;
    }

    .article .content ul,
    .article .content ol{
      margin: 0 0 1.6rem 1.4rem;
      color: color-mix(in oklab, var(--silver) 85%, var(--silver-dim));
      max-width: 100%;
    }
    .article .content li{ margin: 0.35rem 0; }

    .article .content blockquote{
      margin: 1.8rem 0;
      padding: 1.1rem 1.2rem;
      border-left: 3px solid var(--gold);
      background: color-mix(in oklab, var(--panel) 75%, transparent);
      border-radius: 10px;
      color: color-mix(in oklab, var(--silver) 75%, var(--gold-soft));
      max-width: 100%;
    }

    .article .content img,
    .article .content video,
    .article .content svg{
      max-width: 100%;
      height: auto;
      display: block;
    }

    /* Tables: ensure no horizontal overflow beyond viewport */
    .article .content table{
      width: 100%;
      border-collapse: collapse;
      margin: 1.8rem 0;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--panel) 70%, transparent);
      border-radius: 12px;
      overflow:hidden;
      display: block;
      max-width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .article .content thead, .article .content tbody, .article .content tr{
      width: 100%;
    }
    .article .content th,
    .article .content td{
      padding: 12px 12px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
      font-family: var(--font-ui);
      font-size: 0.92rem;
      line-height: 1.35;
      color: color-mix(in oklab, var(--silver) 82%, var(--silver-dim));
      white-space: nowrap;
    }
    .article .content th{
      text-transform: uppercase;
      letter-spacing: 1.2px;
      font-size: 0.78rem;
      color: var(--gold);
      background: color-mix(in oklab, var(--panel) 85%, transparent);
    }

    /* Code blocks: never exceed screen */
    .article .content code{
      font-family: var(--font-mono);
      font-size: 0.92em;
      background: color-mix(in oklab, var(--panel) 82%, transparent);
      border: 1px solid var(--border);
      padding: 0.12em 0.34em;
      border-radius: 8px;
      color: color-mix(in oklab, var(--silver) 70%, var(--gold));
      overflow-wrap: anywhere;
    }
    .article .content pre{
      margin: 1.6rem 0;
      padding: 14px 14px;
      overflow:auto;
      max-width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--panel-strong) 92%, transparent);
      -webkit-overflow-scrolling: touch;
    }
    .article .content pre code{
      background: transparent;
      border: none;
      padding: 0;
      color: color-mix(in oklab, var(--silver) 80%, var(--silver-dim));
      white-space: pre;
    }

    .loader{
      width: 38px; height: 38px;
      border-radius: 999px;
      border: 2px solid color-mix(in oklab, var(--gold) 55%, var(--border));
      border-top-color: transparent;
      margin: 42px auto;
      animation: spin 0.85s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    @media (prefers-reduced-motion: reduce){
      *{ scroll-behavior: auto !important; }
      .card, .cta, .nav-btn, .view{ transition: none !important; }
    }
  </style>

  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      options: { ignoreHtmlClass: 'tex2jax_ignore', processHtmlClass: 'tex2jax_process' },
      chtml: { displayAlign: 'center' }
    };
  </script>
</head>

<body>
  <canvas id="econometric-canvas" aria-hidden="true"></canvas>
  <div id="reading-progress" aria-hidden="true"></div>

  <nav id="global-nav" aria-label="Primary">
    <div class="brand" id="btn-home" role="button" tabindex="0">Anƒ±l Kaya</div>
    <div class="nav-actions">
      <button class="nav-btn" id="btn-archives" type="button">Archives</button>

      <a class="nav-btn nav-link-btn"
         href="https://www.linkedin.com/in/anillkaya"
         target="_blank"
         rel="noopener noreferrer"
         aria-label="Open LinkedIn profile in a new tab">
        LinkedIn
      </a>

      <button class="nav-btn" id="btn-theme" type="button" aria-label="Toggle theme">Light</button>
    </div>
  </nav>

  <main id="app" aria-label="App">
    <section id="view-landing" class="view active" aria-label="Landing">
      <div class="landing">
        <h1>Anƒ±l Kaya</h1>
        <div class="divider" aria-hidden="true"></div>
        <div class="landing-actions">
          <button class="cta gold" id="btn-enter" type="button">Enter Archives</button>
        </div>
      </div>
    </section>

    <section id="view-deck" class="view hidden" aria-label="Archives">
      <header class="deck-header">
        <h2>Research Archives</h2>
        <div class="line" aria-hidden="true"></div>
      </header>
      <div class="card-grid" id="card-grid" aria-label="Article list"></div>
    </section>

    <section id="view-reader" class="view hidden" aria-label="Reader">
      <div class="reader-shell" id="reader-container"></div>
    </section>
  </main>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
  <script id="MathJax-script" defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <script defer>
    const ARTICLE_MANIFEST = [
      {
        id: "bvar",
        file: "./articles/bvar.html",
        category: "Core Theory",
        title: "Bayesian Vector Autoregression",
        date: "OCT 2024",
        excerpt: "A comprehensive guide covering Minnesota priors, hierarchical estimation, and large-scale forecasting algorithms.",
        enabled: true
      },
      {
        id: "stoch-vol",
        file: "./articles/stochastic-volatility.html",
        category: "Time Variance",
        title: "Stochastic Volatility",
        date: "NOV 2024",
        excerpt: "Modeling structural breaks and changing error variance in post-pandemic macroeconomic data using state-space methods.",
        enabled: false
      },
      {
        id: "sign-rest",
        file: "./articles/sign-restrictions.html",
        category: "Identification",
        title: "Sign Restrictions",
        date: "DEC 2024",
        excerpt: "Moving beyond Cholesky: set-identified structural shocks using robust Bayesian sampling methods.",
        enabled: false
      }
    ];

    /* Theme */
    const Theme = (() => {
      const LS_KEY = "theme";
      const root = document.documentElement;
      const media = window.matchMedia ? window.matchMedia("(prefers-color-scheme: dark)") : null;

      function getInitialTheme() {
        const saved = localStorage.getItem(LS_KEY);
        if (saved === "light" || saved === "dark") return saved;
        if (media && media.matches) return "dark";
        return "light";
      }

      function apply(theme, persist = true) {
        root.setAttribute("data-theme", theme);
        if (persist) localStorage.setItem(LS_KEY, theme);

        const btn = document.getElementById("btn-theme");
        if (btn) btn.textContent = (theme === "dark") ? "Light" : "Dark";

        const meta = document.querySelector('meta[name="theme-color"]');
        if (meta) meta.setAttribute("content", theme === "dark" ? "#050505" : "#fbfbfc");

        Visuals.syncTheme();
      }

      function toggle() {
        const current = root.getAttribute("data-theme") || "dark";
        apply(current === "dark" ? "light" : "dark");
      }

      return { apply, toggle, getInitialTheme };
    })();

    /* Visuals (equations + connections) */
    const Visuals = (() => {
      const canvas = document.getElementById("econometric-canvas");
      const ctx = canvas.getContext("2d", { alpha: false });

      let w = 0, h = 0, dpr = 1;

      let bg = "#050505";
      let ink = "rgba(212,175,55,0.46)";
      let inkSoft = "rgba(212,175,55,0.18)";
      let stroke = "rgba(0,0,0,0.55)";
      let glow = "rgba(212,175,55,0.34)";

      const formulas = [
        "ùë¶‚Çú = ùõΩùë•‚Çú + ùúñ‚Çú",
        "Œ£ = ùê¥‚Åª¬πŒõùê¥‚Åª¬π‚Ä≤",
        "‚àá‚Ñí(ùúÉ)",
        "ùëÉ(ùê¥|ùêµ)",
        "‚à´ ùëí‚ÅªÀ£¬≤ ùëëùë•",
        "ùúé¬≤‚Çú",
        "Œîùë¶‚Çú",
        "ùúñ ‚àº ùëÅ(0,1)",
        "‚Ñç‚ÇÄ: ùõΩ = 0",
        "ùê∏[ùë¶‚Çú|‚Ñê‚Çú‚Çã‚ÇÅ]",
        "ùëå‚Çú = ùê¥‚ÇÅùëå‚Çú‚Çã‚ÇÅ + ‚ãØ + ùê¥‚Çöùëå‚Çú‚Çã‚Çö + ùë¢‚Çú",
        "ùëù(ùúÉ|ùëå) ‚àù ùëù(ùëå|ùúÉ)ùëù(ùúÉ)"
      ];

      let nodes = [];
      let drops = [];
      let hero = [];
      const reduceMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

      function cssVar(name) {
        return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
      }

      function syncTheme() {
        bg = cssVar("--canvas-bg") || bg;
        ink = cssVar("--canvas-ink") || ink;
        inkSoft = cssVar("--canvas-ink-soft") || inkSoft;
        stroke = cssVar("--canvas-stroke") || stroke;
        glow = cssVar("--canvas-glow") || glow;
      }

      function resize() {
        dpr = Math.min(window.devicePixelRatio || 1, 2);
        w = window.innerWidth;
        h = window.innerHeight;

        canvas.width = Math.floor(w * dpr);
        canvas.height = Math.floor(h * dpr);

        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);

        build();
      }

      function build() {
        const isMobile = w < 820;
        const nodeCount = reduceMotion ? (isMobile ? 18 : 36) : (isMobile ? 40 : 100);
        const dropCount = reduceMotion ? (isMobile ? 14 : 24) : (isMobile ? 24 : 58);

        nodes = Array.from({ length: nodeCount }, () => ({
          x: Math.random() * w,
          y: Math.random() * h,
          vx: (Math.random() - 0.5) * (isMobile ? 0.55 : 0.75),
          vy: (Math.random() - 0.5) * (isMobile ? 0.55 : 0.75),
          r: Math.random() * (isMobile ? 1.4 : 1.8) + 0.6
        }));

        drops = Array.from({ length: dropCount }, () => ({
          x: Math.random() * w,
          y: Math.random() * h,
          vy: Math.random() * (isMobile ? 0.85 : 1.05) + 0.25,
          size: Math.random() * (isMobile ? 14 : 18) + (isMobile ? 12 : 13),
          a: Math.random() * 0.28 + 0.18,
          text: formulas[(Math.random() * formulas.length) | 0]
        }));

        const heroCount = reduceMotion ? 2 : (isMobile ? 3 : 5);
        hero = Array.from({ length: heroCount }, () => ({
          x: Math.random() * w,
          y: Math.random() * h,
          vx: (Math.random() - 0.5) * 0.10,
          vy: (Math.random() - 0.5) * 0.10,
          size: Math.random() * (isMobile ? 18 : 26) + (isMobile ? 22 : 30),
          a: Math.random() * 0.10 + 0.10,
          text: formulas[(Math.random() * formulas.length) | 0]
        }));
      }

      function drawTextWithStroke(text, x, y, fontSize, alpha, isHero = false) {
        ctx.save();
        ctx.font = `italic ${fontSize}px "Latin Modern Roman", "Times New Roman"`;
        ctx.textBaseline = "alphabetic";

        ctx.shadowColor = glow;
        ctx.shadowBlur = isHero ? 18 : 12;

        ctx.globalAlpha = Math.min(1, alpha * (isHero ? 0.95 : 0.85));
        ctx.lineWidth = isHero ? 2.0 : 1.25;
        ctx.strokeStyle = stroke;
        ctx.strokeText(text, x, y);

        ctx.globalAlpha = alpha;
        ctx.fillStyle = ink;
        ctx.fillText(text, x, y);

        ctx.restore();
      }

      function step() {
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, w, h);

        for (const e of hero) {
          e.x += e.vx; e.y += e.vy;
          if (e.x < -400) e.x = w + 200;
          if (e.x > w + 400) e.x = -200;
          if (e.y < -200) e.y = h + 120;
          if (e.y > h + 200) e.y = -120;
          drawTextWithStroke(e.text, e.x, e.y, e.size, e.a, true);
        }

        for (const d of drops) {
          d.y += d.vy;
          if (d.y > h + 80) {
            d.y = -80;
            d.x = Math.random() * w;
            d.text = formulas[(Math.random() * formulas.length) | 0];
            d.size = Math.random() * (w < 820 ? 14 : 18) + (w < 820 ? 12 : 13);
            d.a = Math.random() * 0.28 + 0.18;
            d.vy = Math.random() * (w < 820 ? 0.85 : 1.05) + 0.25;
          }
          drawTextWithStroke(d.text, d.x, d.y, d.size, d.a, false);
        }

        const isMobile = w < 820;
        const maxDist = isMobile ? 105 : 150;
        const maxDist2 = maxDist * maxDist;

        for (const n of nodes) {
          n.x += n.vx; n.y += n.vy;
          if (n.x < -20) n.x = w + 20;
          if (n.x > w + 20) n.x = -20;
          if (n.y < -20) n.y = h + 20;
          if (n.y > h + 20) n.y = -20;
        }

        ctx.save();
        ctx.lineWidth = 1;

        for (let i = 0; i < nodes.length; i++) {
          for (let j = i + 1; j < nodes.length; j++) {
            const a = nodes[i], b = nodes[j];
            const dx = a.x - b.x, dy = a.y - b.y;
            const d2 = dx*dx + dy*dy;
            if (d2 < maxDist2) {
              const t = 1 - d2 / maxDist2;
              ctx.globalAlpha = Math.min(0.42, t * 0.28);
              ctx.strokeStyle = inkSoft;
              ctx.beginPath();
              ctx.moveTo(a.x, a.y);
              ctx.lineTo(b.x, b.y);
              ctx.stroke();
            }
          }
        }

        ctx.globalAlpha = 1;
        for (const n of nodes) {
          ctx.beginPath();
          ctx.arc(n.x, n.y, n.r, 0, Math.PI * 2);
          ctx.fillStyle = inkSoft;
          ctx.globalAlpha = 0.9;
          ctx.fill();
        }

        ctx.restore();
        requestAnimationFrame(step);
      }

      function init() {
        syncTheme();
        resize();
        window.addEventListener("resize", resize, { passive: true });
        requestAnimationFrame(step);
      }

      return { init, syncTheme };
    })();

    /* App */
    const App = (() => {
      const el = (id) => document.getElementById(id);

      const views = {
        landing: el("view-landing"),
        deck: el("view-deck"),
        reader: el("view-reader")
      };

      const nav = el("global-nav");
      const progress = el("reading-progress");
      const deckGrid = el("card-grid");
      const readerContainer = el("reader-container");

      let state = { view: "landing" };
      let rafScrollPending = false;

      function setNavScrolled(scrolled) {
        nav.classList.toggle("scrolled", !!scrolled);
      }

      function switchView(to) {
        const from = state.view;
        if (from === to) return;

        // hide previous
        views[from].classList.remove("active");
        setTimeout(() => { views[from].classList.add("hidden"); }, 180);

        // show next
        views[to].classList.remove("hidden");
        requestAnimationFrame(() => views[to].classList.add("active"));

        // reset scroll on view change
        views[to].scrollTop = 0;

        progress.style.opacity = (to === "reader") ? "1" : "0";
        if (to !== "reader") progress.style.width = "0%";

        state.view = to;
        setNavScrolled(to !== "landing");
      }

      function goHome() { switchView("landing"); }
      function enterDeck() { switchView("deck"); }

      function renderDeck() {
        deckGrid.innerHTML = ARTICLE_MANIFEST.map((a, i) => {
          const disabled = !a.enabled;
          return `
            <article class="card" role="button" tabindex="${disabled ? -1 : 0}"
              aria-disabled="${disabled ? "true" : "false"}"
              data-article-id="${a.id}">
              <div class="card-top">
                <span>${String(i + 1).padStart(2, "0")} ¬∑ ${a.category}</span>
                <span>${a.date}</span>
              </div>
              <h3>${a.title}</h3>
              <p>${a.excerpt}</p>
              <div class="read"><span>Read</span><span aria-hidden="true">‚Üí</span></div>
            </article>
          `;
        }).join("");

        deckGrid.querySelectorAll(".card").forEach(card => {
          const id = card.getAttribute("data-article-id");
          const article = ARTICLE_MANIFEST.find(x => x.id === id);
          if (!article || !article.enabled) return;

          card.addEventListener("click", () => openArticle(id));
          card.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              openArticle(id);
            }
          });
        });
      }

      function estimateReadTime(text) {
        const words = (text || "").trim().split(/\s+/).filter(Boolean).length;
        const minutes = Math.max(1, Math.round(words / 220));
        return `${minutes} min read`;
      }

      function buildReaderShell(article, contentHTML) {
        return `
          <details class="mobile-toc" id="mobile-toc">
            <summary>Contents</summary>
            <div class="toc-links" id="mobile-toc-links"></div>
          </details>

          <div class="reader-layout">
            <aside class="toc" aria-label="Table of contents">
              <h4>Contents</h4>
              <ul id="toc-list"></ul>
            </aside>

            <article class="article">
              <header class="article-header">
                <div class="meta">
                  <span class="pill">${article.category}</span>
                  <span>${article.date}</span>
                  <span>‚Ä¢</span>
                  <span id="readtime">‚Ä¶</span>
                </div>
                <h1>${article.title}</h1>
              </header>
              <div class="content" id="article-content">
                ${contentHTML}
              </div>
            </article>
          </div>
        `;
      }

      function ensureHeadingIds(scope) {
        const headings = scope.querySelectorAll("h2, h3");
        let k = 0;
        headings.forEach(h => {
          if (!h.id) {
            const slug = h.textContent
              .toLowerCase()
              .trim()
              .replace(/[^\w\s-]/g, "")
              .replace(/\s+/g, "-")
              .slice(0, 60);
            h.id = slug ? `${slug}-${k++}` : `section-${k++}`;
          }
        });
        return headings;
      }

      function stripInlineTOC(articleEl) {
        if (!articleEl) return;

        const explicitSelectors = ["#toc", ".toc", "nav.toc", ".table-of-contents", ".contents", "[data-toc]"];
        explicitSelectors.forEach(sel => articleEl.querySelectorAll(sel).forEach(n => n.remove()));

        const candidates = Array.from(articleEl.children).slice(0, 4);
        for (const c of candidates) {
          const links = Array.from(c.querySelectorAll("a[href]"));
          if (links.length < 5) continue;

          const hashLinks = links.filter(a => {
            const href = (a.getAttribute("href") || "").trim();
            return href.startsWith("#");
          });

          if (hashLinks.length >= 5 && hashLinks.length / links.length > 0.7) {
            c.remove();
            break;
          }
        }
      }

      function buildTOC(readerRoot) {
        const tocList = readerRoot.querySelector("#toc-list");
        const mobileLinks = readerRoot.querySelector("#mobile-toc-links");
        if (!tocList || !mobileLinks) return;

        tocList.innerHTML = "";
        mobileLinks.innerHTML = "";

        const content = readerRoot.querySelector("#article-content");
        if (!content) return;

        const headings = ensureHeadingIds(content);
        const h2s = Array.from(headings).filter(h => h.tagName.toLowerCase() === "h2");

        if (h2s.length === 0) {
          const toc = readerRoot.querySelector(".toc");
          const mtoc = readerRoot.querySelector(".mobile-toc");
          if (toc) toc.style.display = "none";
          if (mtoc) mtoc.style.display = "none";
          return;
        }

        for (const h of h2s) {
          const li = document.createElement("li");
          li.innerHTML = `<a href="#${h.id}" class="toc-link">${h.textContent}</a>`;
          li.querySelector("a").addEventListener("click", (e) => {
            e.preventDefault();
            h.scrollIntoView({ behavior: "smooth", block: "start" });
          });
          tocList.appendChild(li);

          const a2 = document.createElement("a");
          a2.href = `#${h.id}`;
          a2.textContent = h.textContent;
          a2.addEventListener("click", (e) => {
            e.preventDefault();
            h.scrollIntoView({ behavior: "smooth", block: "start" });
            const mtoc = readerRoot.querySelector("#mobile-toc");
            if (mtoc) mtoc.open = false;
          });
          mobileLinks.appendChild(a2);
        }
      }

      function updateProgressAndTOC() {
        const scroller = views.reader;
        const total = scroller.scrollHeight - scroller.clientHeight;
        const pct = total > 0 ? Math.min(100, Math.max(0, (scroller.scrollTop / total) * 100)) : 0;
        progress.style.width = pct.toFixed(2) + "%";

        const links = readerContainer.querySelectorAll(".toc-link");
        const headings = readerContainer.querySelectorAll("#article-content h2[id]");
        if (!links.length || !headings.length) return;

        let currentId = "";
        const y = scroller.scrollTop;

        headings.forEach(h => { if (h.offsetTop - 160 <= y) currentId = h.id; });
        links.forEach(a => a.classList.toggle("active", a.getAttribute("href") === `#${currentId}`));
      }

      function onReaderScroll() {
        if (rafScrollPending) return;
        rafScrollPending = true;
        requestAnimationFrame(() => {
          rafScrollPending = false;
          updateProgressAndTOC();
          setNavScrolled(true);
        });
      }

      async function openArticle(id) {
        const article = ARTICLE_MANIFEST.find(a => a.id === id);
        if (!article || !article.enabled) return;

        switchView("reader");
        readerContainer.innerHTML = `<div class="loader" aria-label="Loading"></div>`;

        try {
          const res = await fetch(article.file, { cache: "no-store" });
          if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
          const html = await res.text();

          const doc = new DOMParser().parseFromString(html, "text/html");
          const articleNode = doc.querySelector("article") || doc.body;

          stripInlineTOC(articleNode);

          const contentHTML = articleNode ? articleNode.innerHTML : html;
          readerContainer.innerHTML = buildReaderShell(article, contentHTML);

          const text = (readerContainer.querySelector("#article-content")?.innerText || "");
          const rt = readerContainer.querySelector("#readtime");
          if (rt) rt.textContent = estimateReadTime(text);

          buildTOC(readerContainer);

          views.reader.scrollTop = 0;
          progress.style.width = "0%";

          if (window.MathJax && window.MathJax.typesetPromise) {
            try { await window.MathJax.typesetPromise([readerContainer]); } catch (_) {}
          }

          updateProgressAndTOC();
        } catch (err) {
          readerContainer.innerHTML = `
            <div style="padding: 22px 6px;">
              <p style="font-family: var(--font-ui); color: var(--silver-dim); line-height: 1.6;">
                Could not load <strong style="color: var(--gold); font-weight: 800;">${article.file}</strong>.
                Verify the path and that the file is reachable from your server.
              </p>
            </div>
          `;
        }
      }

      function init() {
        renderDeck();

        // nav interactions
        const home = el("btn-home");
        home.addEventListener("click", goHome);
        home.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") { e.preventDefault(); goHome(); }
        });

        el("btn-archives").addEventListener("click", enterDeck);
        el("btn-enter").addEventListener("click", enterDeck);

        // scroll listeners (container scroll, not window)
        views.deck.addEventListener("scroll", () => setNavScrolled(views.deck.scrollTop > 8), { passive: true });
        views.reader.addEventListener("scroll", onReaderScroll, { passive: true });

        // expose optional
        window.__openArticle = openArticle;
      }

      return { init };
    })();

    document.addEventListener("DOMContentLoaded", () => {
      Theme.apply(Theme.getInitialTheme(), false);
      document.getElementById("btn-theme").addEventListener("click", Theme.toggle);

      Visuals.init();
      App.init();
    });
  </script>
</body>
</html>
